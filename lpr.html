<!DOCTYPE html>
<html>
<head>
    <title>iTWATCHER API</title>
    <!-- Add your CSS and JS files here -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        #video-container {
            position: relative;
            width: 1200px;  /* Set to your desired width */
            height: 700px; /* Set to your desired height */
            overflow: hidden;
        }

        #video-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
    
</head>
<body>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <a class="navbar-brand" href="http://{{ip_address}}:8000/my-url/">iTWatcher</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav ml-auto">
            
            <li class="nav-item">
                <a class="nav-link" href="{% url 'display_plates' %}">View Plate Logs</a>
            </li>
            
            
            <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">Logout</a>
            </li>
            <!-- Add more links for other views here -->
        </ul>
    </div>
</nav>

<div class="container mt-4 ml-5">
    <h2>License Plate Recognition</h2>
    <div class="row">
        <div class="col-md-6">
            <form method="post" enctype="multipart/form-data" id="lpr-form">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-12">
                        <label for="selection">Choose Input Type:</label>
                        <select name="selection" id="selection" class="form-control">
                            <option value="video-path">Video File</option>
                            <option value="directory-path">Videos in Database</option>
                            <option value="camera-feed">Camera Feed URL</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3" id="video-path-input">
                    <div class="col-md-12">
                        <label for="video_path">Video file:</label>
                        <select name="video_path" id="video_path" class="form-control">
                            {% for video in videos %}
                                <option value="{{ video.id }}">{{ video.file.path }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mt-3" id="directory-path-input" style="display: none;">
                    <div class="col-md-12">
                        <label for="directory_path">Videos in Database:</label>
                        <textarea readonly name="directory_path" id="directory_path" class="form-control" style="height: 100px; white-space: pre-wrap; word-wrap: break-word; padding: 10px;">
                            {% for video in videos %}
                                {{ video.file.path }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </textarea>
                    </div>
                </div>  
                <div class="row mt-3" id="camera-feed-input" style="display: none;">
                    <div class="col-md-12">
                        <label for="livestream_url">Live stream URL:</label>
                        <input type="text" name="livestream_url" id="livestream_url" class="form-control">
                    </div>
                </div>
                  
                <div class="row mt-3">
                    <div class="col-md-12">
                        <label for="vehicle_type_lpr">Model Type:</label>
                        <select name="vehicle_type" id="vehicle_type_lpr" class="form-control">
                            <option value="tricycle">Tricycle</option>
                            <option value="all_vehicle">Catch All</option>
                            <option value="combi">iTWatcher</option>
                        </select>
                    </div>
                </div>            
                <div class="row mt-3">
                    <div class="col-md-12">
                        <!-- Checkbox to control the display of frames -->
                        <label for="show-display">Show Display</label>
                        <input type="checkbox" id="show-display" name="show_display">
                    </div>
                    <div class="col-md-12">
                        <input type="submit" value="Process" class="btn btn-primary">
                    </div>
                </div>
            </form>
        </div>
        <div class="col-md-6">
            <div id="progress-container" style="display: none;">
                <label for="progress">Processing Video:</label>
                <progress id="progress-bar" value="0" max="100"></progress>
            </div>
            
            <div id="video-container" class="text-right">
                <!-- Video container content -->
                <!-- Ensure no fixed width is applied here -->
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Document is ready");

        document.getElementById('lpr-form').addEventListener('submit', function(event) {
            event.preventDefault();
            console.log("Form submission intercepted.");

            var formData = new FormData(this);
            var selectedOption = document.getElementById('selection').value;
            var selectedAction = document.getElementById('vehicle_type_lpr').value;
            var showDisplay = document.getElementById('show-display').checked;  // Get checkbox state
            
            if (selectedOption === 'video-path') {
                formData.delete('livestream_url');
                formData.delete('directory_path');
            } else if (selectedOption === 'directory-path') {
                formData.delete('video_path');
                formData.delete('livestream_url');

                // Convert the textarea content into an array (assuming videos is a space-separated list of paths)
                var videoPaths = document.getElementById('directory_path').value.split('\n').map(function(path) {
                    return path.trim();  // Make sure there are no extra spaces
                });

                // Append the array of video paths to the form data
                formData.append('video_files', JSON.stringify(videoPaths));  // Send as a JSON string
            } else if (selectedOption === 'camera-feed') {
                formData.delete('video_path');
                formData.delete('directory_path');
            }
            
            formData.append('show_display', showDisplay);  // Append it to the form data

            var actionUrl = '';
            if (selectedAction === 'tricycle') {
                actionUrl = 'http://{{ip_address}}:8000/tracking/lpr_trike/';
            } else if (selectedAction === 'all_vehicle') {
                actionUrl = 'http://{{ip_address}}:8000/tracking/lpr_all/';
            } else if (selectedAction === 'combi') {
                actionUrl = 'http://{{ip_address}}:8000/tracking/lpr_combi/';
            }

            console.log("Sending AJAX request to:", actionUrl);

            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.body;
            })
            .then(body => {
                const reader = body.getReader();
                const decoder = new TextDecoder("utf-8");
                const videoContainer = document.getElementById('video-container');

                // Create three img elements for triple-buffering
                let imgElement1 = document.createElement('img');
                let imgElement2 = document.createElement('img');
                let imgElement3 = document.createElement('img');
                imgElement1.style.opacity = 1;
                imgElement2.style.opacity = 0;
                imgElement3.style.opacity = 0;
                videoContainer.appendChild(imgElement1);
                videoContainer.appendChild(imgElement2);
                videoContainer.appendChild(imgElement3);

                let currentImageElement = imgElement1;
                let nextImageElement = imgElement2;
                let thirdImageElement = imgElement3;

                let frameBuffer = '';
                let frameStarted = false;

                function updateFrame(frameData) {
                    thirdImageElement.style.opacity = 0;
                    thirdImageElement.onload = () => {
                        currentImageElement.style.opacity = 0;
                        nextImageElement.style.opacity = 0;
                        thirdImageElement.style.opacity = 1;

                        // Swap the current and next image elements
                        [currentImageElement, nextImageElement, thirdImageElement] = [nextImageElement, thirdImageElement, currentImageElement];
                    };

                    if (showDisplay) {  // Only display if checkbox is checked
                        thirdImageElement.src = `data:image/jpeg;base64,${frameData}`;
                    } else {
                        imgElement.style.display = 'none';  // Hide if not showing
                    }
                }

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('Stream complete');
                            return;
                        }

                        const chunk = decoder.decode(value, { stream: true });

                        frameBuffer += chunk;

                        let frameStart = frameBuffer.indexOf('data: ');
                        let frameEnd = frameBuffer.indexOf('\n\n', frameStart);

                        while (frameStart !== -1 && frameEnd !== -1) {
                            const frameData = frameBuffer.substring(frameStart + 6, frameEnd);
                            updateFrame(frameData);

                            frameBuffer = frameBuffer.substring(frameEnd + 2);

                            frameStart = frameBuffer.indexOf('data: ');
                            frameEnd = frameBuffer.indexOf('\n\n', frameStart);
                        }

                        read();
                    });
                }

                read();
            })
            .catch(error => {
                console.error('AJAX error:', error);
                alert("An error occurred: " + error);
            });
        });

        document.getElementById('selection').addEventListener('change', function() {
            console.log("Selection changed");
            var selectedOption = this.value;
            if (selectedOption === 'video-path') {
                document.getElementById('video-path-input').style.display = 'block';
                document.getElementById('directory-path-input').style.display = 'none';
                document.getElementById('camera-feed-input').style.display = 'none';
            } else if (selectedOption === 'directory-path') {
                document.getElementById('video-path-input').style.display = 'none';
                document.getElementById('directory-path-input').style.display = 'block';
                document.getElementById('camera-feed-input').style.display = 'none';
            } else if (selectedOption === 'camera-feed') {
                document.getElementById('video-path-input').style.display = 'none';
                document.getElementById('directory-path-input').style.display = 'none';
                document.getElementById('camera-feed-input').style.display = 'block';
            }
        });
    });
</script>


    
</body>
</html>